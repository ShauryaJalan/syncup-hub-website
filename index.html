<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncUp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS for simple browser hosting */
        html, body {
            margin: 0;
            padding: 0;
            background-color: #ffffff; 
            width: 100%;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #1f2937; }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #ffffff;
            animation: spin 1s ease-in-out infinite;
        }
    </style>
    <script type="module">
        // --- LOCAL STORAGE CONFIGURATION ---
        
        // Key for saving all application data in the browser
        const LOCAL_STORAGE_KEY = 'syncUpLocalData_v1';
        const USER_ID_KEY = 'syncUpLocalUserId';

        // Global App State (Replaced Firebase arrays with local arrays)
        window.appState = {
            isAuthReady: false,
            userId: null,
            activePage: 'Home', 
            lostItems: [], 
            foundItems: [], 
            syncRequests: [], 
            message: null,
            socialSyncTab: 'Gym',
        };

        const SPORTS_OPTIONS = [
            'Swimming', 'Basketball', 'Football', 'Handball', 'Badminton',
            'Squash', 'Table Tennis', 'Tennis', 'Snooker', 'Carrom', 'Chess'
        ];

        // --- LOCAL PERSISTENCE UTILITIES ---
        
        function getLocalUserId() {
            let userId = localStorage.getItem(USER_ID_KEY);
            if (!userId) {
                // Generate a persistent unique ID for tracking history
                userId = crypto.randomUUID();
                localStorage.setItem(USER_ID_KEY, userId);
            }
            return userId;
        }

        function loadStateFromLocal() {
            // Retrieve all data (lost/found/sync) from browser storage
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                window.appState.lostItems = parsedData.lostItems || [];
                window.appState.foundItems = parsedData.foundItems || [];
                window.appState.syncRequests = parsedData.syncRequests || [];
            }
        }

        function saveStateToLocal() {
            // Save all current data back to browser storage
            const dataToSave = {
                lostItems: window.appState.lostItems,
                foundItems: window.appState.foundItems,
                syncRequests: window.appState.syncRequests,
            };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
            renderApp(); // Re-render to show updated lists
        }


        // --- UTILITY FUNCTIONS ---

        function showMessage(text, isError = false) {
            window.appState.message = { text, isError };
            renderApp();
            setTimeout(() => {
                window.appState.message = null;
                renderApp();
            }, 3000);
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            // Use local Date object since Firestore Timestamp object is removed
            const date = new Date(timestamp);
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            return `${dateStr} at ${timeStr}`;
        }
        
        // --- UI COMPONENTS (Formal Design) ---

        function renderLoading() {
            return `
                <div class="flex flex-col items-center justify-center min-h-screen w-full bg-gray-50 p-10">
                    <div class="spinner border-gray-300 border-t-gray-700"></div>
                    <p class="mt-4 text-gray-700 font-medium">Loading SyncUp Data...</p>
                    <p class="text-sm text-gray-500 mt-2">History is saved locally in your browser.</p>
                </div>
            `;
        }

        function getHeaderHtml() {
            const pages = ['Home', 'Lost & Found', 'Social Sync'];
            return `
                <div class="w-full bg-gray-800 text-white shadow-md sticky top-0 z-10 border-b border-gray-700">
                    <div class="max-w-6xl mx-auto p-4 flex justify-between items-center">
                        <h1 class="text-xl sm:text-3xl font-serif font-bold tracking-widest text-white">SYNCUP</h1>
                        <div id="user-id-display" class="text-xs bg-gray-700 px-2 py-1 rounded-sm opacity-75">
                            User ID: ${window.appState.userId ? window.appState.userId.substring(0, 8) + '...' : 'Loading...'}
                        </div>
                    </div>
                    <nav class="max-w-6xl mx-auto flex justify-center border-t border-gray-700 sm:border-t-0">
                        ${pages.map(page => `
                            <button data-page="${page}" 
                                class="page-button flex-1 sm:flex-none px-2 sm:px-6 py-3 text-sm sm:text-lg text-center font-medium transition-all duration-300 
                                ${window.appState.activePage === page ? 'border-b-4 border-slate-300 text-slate-300 bg-gray-700' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}"
                            >
                                ${page.replace(' & ', ' &<br class="sm:hidden">')}
                            </button>
                        `).join('')}
                    </nav>
                </div>
            `;
        }
        
        // --- HOME PAGE RENDERING ---

        function renderHomePage() {
            return `
                <div class="w-full max-w-6xl p-4 sm:p-6 space-y-12">
                    <!-- Hero Image -->
                    <div class="rounded-lg overflow-hidden border border-gray-300">
                        <img src="https://placehold.co/1200x200/1F2937/ffffff?text=SyncUp+Student+Services" 
                             onerror="this.onerror=null; this.src='https://placehold.co/1200x200/1F2937/ffffff?text=SyncUp+Student+Services';" 
                             alt="SyncUp Banner" class="w-full h-auto object-cover">
                    </div>

                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 text-center border-b pb-2">Centralized Campus Connection</h2>
                    
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Lost & Found Intro Card -->
                        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-sm border border-gray-200 border-t-4 border-red-800 hover:shadow-md transition duration-300">
                            <h3 class="text-xl font-semibold text-red-800 mb-3 border-b pb-1">Lost & Found Service</h3>
                            <p class="text-gray-600 mb-6">A straightforward channel for reporting lost possessions and listing found items. Our system facilitates quick, verified contact exchange for efficient item recovery.</p>
                            <img src="https://placehold.co/600x250/B91C1C/ffffff?text=Lost+Assets" alt="Lost and Found" class="w-full h-32 object-cover rounded-md mb-4 border border-gray-200">
                            <button data-page="Lost & Found" class="page-button w-full py-2 px-4 rounded-sm shadow-sm text-white font-medium bg-gray-700 hover:bg-gray-800 transition duration-150">
                                Access Lost & Found
                            </button>
                        </div>
                        
                        <!-- Social Sync Intro Card -->
                        <div class="bg-white p-6 sm:p-8 rounded-lg shadow-sm border border-gray-200 border-t-4 border-slate-700 hover:shadow-md transition duration-300">
                            <h3 class="text-xl font-semibold text-slate-700 mb-3 border-b pb-1">Social Sync Coordination</h3>
                            <p class="text-gray-600 mb-6">Coordinate specific meetups for athletic, fitness, or academic purposes. Post your time and location to instantly find a reliable partner or group.</p>
                            <img src="https://placehold.co/600x250/475569/ffffff?text=Social+Coordination" alt="Social Sync" class="w-full h-32 object-cover rounded-md mb-4 border border-gray-200">
                            <button data-page="Social Sync" class="page-button w-full py-2 px-4 rounded-sm shadow-sm text-white font-medium bg-slate-700 hover:bg-slate-800 transition duration-150">
                                Access Social Sync
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }


        function getFooterHtml() {
            return `
                <div class="w-full bg-gray-100 mt-8 py-4 text-center text-gray-600 text-sm border-t border-gray-300">
                    &copy; ${new Date().getFullYear()} SyncUp. History stored in your browser.
                </div>
            `;
        }

        function renderMessage() {
            if (!window.appState.message) return '';
            const { text, isError } = window.appState.message;
            const bgColor = isError ? 'bg-red-700' : 'bg-teal-700'; 
            return `
                <div class="fixed top-0 left-1/2 transform -translate-x-1/2 mt-4 p-4 rounded-md shadow-xl text-white font-semibold z-50 transition-opacity duration-500 ${bgColor}">
                    ${text}
                </div>
            `;
        }

        // --- LOST & FOUND RENDERING ---

        function renderLostAndFound() {
            return `
                <div class="w-full max-w-6xl p-4 sm:p-6 space-y-8">
                    <img src="https://placehold.co/1200x150/1F2937/ffffff?text=LOST+%26+FOUND+DIRECTORY" alt="Lost and Found Header" class="w-full rounded-md shadow-sm mb-4 border border-gray-300">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 border-b pb-2 border-red-800">Lost & Found Center</h2>

                    <!-- Posting Forms -->
                    <div class="grid md:grid-cols-2 gap-6">
                        ${renderLostItemForm()}
                        ${renderFoundItemForm()}
                    </div>

                    <!-- Listings -->
                    ${renderLostAndFoundListings()}
                </div>
            `;
        }

        function renderLostItemForm() {
            return `
                <div class="bg-white p-6 rounded-md shadow-sm border border-gray-200 border-t-4 border-red-800">
                    <h3 class="text-lg sm:text-xl font-semibold mb-4 text-red-800">Report Lost Item</h3>
                    <form id="lost-item-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Item Name</label>
                            <input type="text" id="lost-item-name" required class="mt-1 block w-full rounded-sm border-gray-300 shadow-sm p-2 border focus:border-red-800 focus:ring-red-800">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Description / Last Seen</label>
                            <textarea id="lost-item-desc" required rows="3" class="mt-1 block w-full rounded-sm border-gray-300 shadow-sm p-2 border focus:border-red-800 focus:ring-red-800"></textarea>
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-sm shadow-sm text-white font-medium bg-red-800 hover:bg-red-900 transition duration-150">
                            Post Lost Item
                        </button>
                    </form>
                </div>
            `;
        }

        function renderFoundItemForm() {
            return `
                <div class="bg-white p-6 rounded-md shadow-sm border border-gray-200 border-t-4 border-green-800">
                    <h3 class="text-lg sm:text-xl font-semibold mb-4 text-green-800">List Found Item</h3>
                    <form id="found-item-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Item Name</label>
                            <input type="text" id="found-item-name" required class="mt-1 block w-full rounded-sm border-gray-300 shadow-sm p-2 border focus:border-green-800 focus:ring-green-800">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Location Found</label>
                            <textarea id="found-item-desc" required rows="3" class="mt-1 block w-full rounded-sm border-gray-300 shadow-sm p-2 border focus:border-green-800 focus:ring-green-800"></textarea>
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-sm shadow-sm text-white font-medium bg-green-800 hover:bg-green-900 transition duration-150">
                            Post Found Item
                        </button>
                    </form>
                </div>
            `;
        }

        function renderLostAndFoundListings() {
            // Combine and sort by latest post first
            const allItems = [...window.appState.lostItems, ...window.appState.foundItems].sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            return `
                <div class="space-y-6">
                    <h3 class="text-xl sm:text-2xl font-bold text-gray-800 pt-4 border-b border-gray-200 pb-2">Community Listings (${allItems.length} Active)</h3>
                    <div class="space-y-4">
                        ${allItems.length === 0 ? '<p class="text-gray-500 text-center py-8 bg-gray-50 rounded-md shadow-inner border border-gray-200">No active listings right now. Be the first to post!</p>' : allItems.map(item => {
                            const isLost = item.type === 'Lost';
                            const borderColor = isLost ? 'border-red-800' : 'border-green-800';
                            const titleColor = isLost ? 'text-red-800' : 'text-green-800';
                            const buttonColor = isLost ? 'bg-gray-700 hover:bg-gray-900' : 'bg-slate-700 hover:bg-slate-800';
                            const buttonText = isLost ? 'I Found This Item!' : 'I Lost This Item!';
                            const timestamp = formatTimestamp(item.timestamp);
                            const isPoster = item.posterId === window.appState.userId;

                            return `
                                <div class="bg-white p-4 rounded-md shadow-sm border border-gray-200 border-l-4 ${borderColor} flex flex-col sm:flex-row justify-between items-start sm:items-center transition duration-200 hover:shadow-md">
                                    <div class="w-full sm:w-auto mb-3 sm:mb-0">
                                        <div class="font-semibold text-base ${titleColor}">${item.type} | ${item.item}</div>
                                        <p class="text-gray-600 text-sm">${item.description}</p>
                                        <p class="text-xs text-gray-500 mt-1">Posted: ${timestamp} ${isPoster ? '(Your Post)' : ''}</p>
                                        <span class="text-xs font-medium ${item.status === 'Matched' ? 'text-teal-700' : 'text-gray-500'}">
                                            Status: ${item.status}
                                        </span>
                                        ${item.status === 'Matched' ? `<p class="mt-1 text-sm font-bold text-gray-800">Contact: ${item.contact}</p>` : ''}
                                    </div>
                                    ${item.status === 'Active' && !isPoster ? `
                                        <button data-id="${item.id}" data-type="${item.type}" class="match-item-btn w-full sm:w-auto py-2 px-4 rounded-sm text-white font-medium text-sm ${buttonColor} transition duration-150">
                                            ${buttonText}
                                        </button>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // --- SOCIAL SYNC RENDERING ---

        function renderSocialSync() {
            const categories = ['Gym', 'Sports', 'Study'];

            return `
                <div class="w-full max-w-6xl p-4 sm:p-6 space-y-8">
                    <img src="https://placehold.co/1200x150/475569/ffffff?text=SOCIAL+SYNC+COORDINATION" alt="Social Sync Header" class="w-full rounded-md shadow-sm mb-4 border border-gray-300">
                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 border-b pb-2 border-slate-700">Social Sync Matchmaker</h2>
                    
                    <!-- Internal Tabs for Social Sync -->
                    <div class="flex border-b border-gray-200">
                        ${categories.map(cat => `
                            <button data-sync-tab="${cat}" 
                                class="sync-tab-button flex-1 px-2 py-2 text-base sm:px-4 sm:text-lg text-center font-medium transition-all duration-300 
                                ${window.appState.socialSyncTab === cat ? 'border-b-4 border-slate-700 text-slate-700 font-semibold' : 'text-gray-500 hover:text-slate-700'}"
                            >
                                ${cat}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div id="social-sync-content">
                        ${renderSyncPostForm(categories)}
                        ${renderSyncListings(window.appState.socialSyncTab)}
                    </div>
                </div>
            `;
        }

        function renderSyncPostForm(categories) {
            return `
                <div class="bg-white p-6 rounded-md shadow-sm border border-gray-200 border-t-4 border-slate-700 mt-6">
                    <h3 class="text-lg sm:text-xl font-semibold mb-4 text-slate-700">Post a Sync-Up Request</h3>
                    <form id="sync-post-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Category</label>
                            <select id="sync-category" required class="mt-1 block w-full rounded-sm border-gray-300 shadow-sm p-2 border focus:border-slate-700 focus:ring-slate-700">
                                <option value="">Select Category</option>
                                ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                        </div>
                        <div id="sport-select-container" class="hidden">
                            <label class="block text-sm font-medium text-gray-700">Select Sport</label>
                            <select id="sync-sport" class="mt-1 block w-full rounded-sm border-gray-300 shadow-sm p-2 border focus:border-slate-700 focus:ring-slate-700">
                                ${SPORTS_OPTIONS.map(sport => `<option value="${sport}">${sport}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Time / Location</label>
                            <input type="text" id="sync-time" placeholder="e.g., 6 PM at Rec Center" required class="mt-1 block w-full rounded-sm border-gray-300 shadow-sm p-2 border focus:border-slate-700 focus:ring-slate-700">
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-sm shadow-sm text-white font-medium bg-slate-700 hover:bg-slate-800 transition duration-150">
                            Post Sync Request
                        </button>
                    </form>
                </div>
            `;
        }

        function renderSyncListings(activeCategory) {
            const categoryRequests = window.appState.syncRequests.filter(req => req.category === activeCategory && req.status === 'Active');
            
            return `
                <div class="mt-6 space-y-4">
                    <h3 class="text-xl sm:text-2xl font-bold text-gray-800">Active ${activeCategory} Requests</h3>
                    <div class="bg-gray-50 p-4 rounded-md shadow-inner border border-gray-200">
                        <div class="space-y-3 max-h-96 overflow-y-auto p-2">
                            ${categoryRequests.length === 0 ? `<p class="text-gray-500 text-sm py-4 text-center">No active requests for ${activeCategory} right now. Post one above!</p>` : categoryRequests.map(req => {
                                const timestamp = formatTimestamp(req.timestamp); 
                                const categoryAccent = req.category === 'Gym' ? 'border-blue-700' : req.category === 'Sports' ? 'border-orange-700' : 'border-purple-700';
                                const isPoster = req.posterId === window.appState.userId;

                                return `
                                <div class="bg-white p-3 rounded-md shadow-sm border border-gray-300 border-l-4 ${categoryAccent}">
                                    <div class="font-semibold text-gray-800">${req.time}</div>
                                    <p class="text-xs text-gray-600 mt-1">${req.details}</p>
                                    ${req.sport ? `<span class="text-xs font-medium text-slate-700">Activity: ${req.sport}</span>` : ''}
                                    <p class="text-xs text-gray-500 mt-1">Posted: ${timestamp} ${isPoster ? '(Your Post)' : ''}</p>
                                    ${req.status === 'Active' && !isPoster ? `
                                        <button data-id="${req.id}" data-category="${req.category}" class="join-sync-btn mt-2 w-full py-1 px-3 text-sm rounded-sm text-white font-medium bg-gray-700 hover:bg-gray-800 transition duration-150">
                                            Join Session
                                        </button>
                                    ` : `
                                        <div class="mt-2 text-xs text-center p-1 font-medium text-gray-500 bg-gray-100 rounded-sm">
                                            ${isPoster ? 'Awaiting Join' : 'Not Active'}
                                        </div>
                                    `}
                                </div>
                            `;
                            }).join('')}
                             ${window.appState.syncRequests.filter(req => req.category === activeCategory && req.status === 'Matched').map(req => {
                                const isMatchRelevant = req.posterId === window.appState.userId || req.matcherId === window.appState.userId;
                                if (!isMatchRelevant) return '';

                                return `
                                <div class="bg-gray-100 p-3 rounded-md shadow-sm border border-green-700 border-l-2 opacity-80">
                                    <div class="font-semibold text-green-700">${req.time} - MATCHED!</div>
                                    <p class="text-xs text-gray-600 mt-1">Contact: ${req.contact}</p>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- MAIN RENDER LOOP ---

        function renderApp() {
            const appRoot = document.getElementById('app-root');
            let mainContent = '';

            if (!window.appState.isAuthReady) {
                appRoot.innerHTML = renderLoading();
                return; 
            }
            
            switch (window.appState.activePage) {
                case 'Home':
                    mainContent = renderHomePage();
                    break;
                case 'Lost & Found':
                    mainContent = renderLostAndFound();
                    break;
                case 'Social Sync':
                    mainContent = renderSocialSync();
                    break;
                default:
                    mainContent = renderHomePage();
            }

            // 1. Render the main structure
            appRoot.innerHTML = `
                ${renderMessage()}
                ${getHeaderHtml()}
                <main class="w-full mx-auto py-4 sm:py-8 bg-gray-100 min-h-[80vh]">
                    <div id="app-container" class="flex flex-col items-center">
                        ${mainContent}
                    </div>
                </main>
                ${getFooterHtml()}
            `;

            // 2. Attach all listeners after rendering
            attachHeaderListeners();
            if (window.appState.activePage === 'Lost & Found') {
                attachLostAndFoundListeners();
            } else if (window.appState.activePage === 'Social Sync') {
                attachSocialSyncListeners();
            }
        }

        // --- LISTENER ATTACHMENT ---
        
        function attachHeaderListeners() {
            document.querySelectorAll('.page-button').forEach(button => {
                button.onclick = (e) => {
                    const newPage = e.currentTarget.dataset.page;
                    if (window.appState.activePage !== newPage) {
                        window.appState.activePage = newPage;
                        renderApp();
                    }
                };
            });
        }
        
        function attachSocialSyncListeners() {
             // Attach listeners for the internal Social Sync tabs
            document.querySelectorAll('.sync-tab-button').forEach(button => {
                button.onclick = (e) => {
                    const newSyncTab = e.currentTarget.dataset.syncTab;
                    if (window.appState.socialSyncTab !== newSyncTab) {
                        window.appState.socialSyncTab = newSyncTab;
                        renderApp();
                    }
                };
            });

            const syncForm = document.getElementById('sync-post-form');
            const categorySelect = document.getElementById('sync-category');
            const sportSelectContainer = document.getElementById('sport-select-container');

            if (categorySelect) {
                categorySelect.onchange = () => {
                    if (categorySelect.value === 'Sports') {
                        sportSelectContainer.classList.remove('hidden');
                    } else {
                        sportSelectContainer.classList.add('hidden');
                    }
                };
            }

            if (syncForm) {
                syncForm.onsubmit = (e) => {
                    e.preventDefault();
                    const category = categorySelect.value;
                    const sport = category === 'Sports' ? document.getElementById('sync-sport').value : null;
                    const time = document.getElementById('sync-time').value;
                    handlePostSyncRequest(category, sport, time);
                };
            }

            document.querySelectorAll('.join-sync-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.currentTarget.dataset.id;
                    const category = e.currentTarget.dataset.category;
                    handleJoinSyncRequest(id, category);
                };
            });
        }
        
        function attachLostAndFoundListeners() {
            const lostForm = document.getElementById('lost-item-form');
            if (lostForm) {
                lostForm.onsubmit = (e) => {
                    e.preventDefault();
                    const name = document.getElementById('lost-item-name').value;
                    const desc = document.getElementById('lost-item-desc').value;
                    handlePostLostItem(name, desc);
                };
            }

            const foundForm = document.getElementById('found-item-form');
            if (foundForm) {
                foundForm.onsubmit = (e) => {
                    e.preventDefault();
                    const name = document.getElementById('found-item-name').value;
                    const desc = document.getElementById('found-item-desc').value;
                    handlePostFoundItem(name, desc);
                };
            }

            document.querySelectorAll('.match-item-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.currentTarget.dataset.id;
                    const type = e.currentTarget.dataset.type;
                    handleMatchItem(id, type);
                };
            });
        }
        
        // --- HANDLERS (LOCAL STORAGE LOGIC) ---
        
        async function handlePostLostItem(name, desc) {
            const newItem = {
                id: crypto.randomUUID(),
                type: 'Lost',
                item: name,
                description: desc,
                posterId: window.appState.userId,
                contact: `User ID: ${window.appState.userId}`,
                status: 'Active',
                timestamp: new Date().toISOString(), // Use ISO string for local storage
            };
            window.appState.lostItems.push(newItem);
            saveStateToLocal();
            showMessage(`Lost item "${name}" posted successfully and saved locally!`);
            document.getElementById('lost-item-form').reset();
        }

        async function handlePostFoundItem(name, desc) {
            const newItem = {
                id: crypto.randomUUID(),
                type: 'Found',
                item: name,
                description: desc,
                posterId: window.appState.userId,
                contact: `User ID: ${window.appState.userId}`,
                status: 'Active',
                timestamp: new Date().toISOString(),
            };
            window.appState.foundItems.push(newItem);
            saveStateToLocal();
            showMessage(`Found item "${name}" listed successfully and saved locally!`);
            document.getElementById('found-item-form').reset();
        }

        async function handleMatchItem(id, type) {
            const list = type === 'Lost' ? window.appState.lostItems : window.appState.foundItems;
            const item = list.find(i => i.id === id);

            if (item) {
                item.status = 'Matched';
                item.matcherId = window.appState.userId;
                item.contact = `Matched by User ID: ${window.appState.userId}`;
                saveStateToLocal();
                showMessage(`Match confirmed! Contact details will be visible to both parties.`);
            }
        }

        async function handlePostSyncRequest(category, sport, time) {
            const details = `Looking to sync up for ${category} session. Meeting at: ${time}`; 

            const newRequest = {
                id: crypto.randomUUID(),
                category: category,
                sport: sport,
                time: time,
                details: details,
                posterId: window.appState.userId,
                contact: `User ID: ${window.appState.userId}`,
                status: 'Active',
                timestamp: new Date().toISOString(),
            };
            window.appState.syncRequests.push(newRequest);
            saveStateToLocal();
            showMessage(`${category} request posted successfully and saved locally!`);
            document.getElementById('sync-post-form').reset();
        }

        async function handleJoinSyncRequest(id, category) {
            const request = window.appState.syncRequests.find(r => r.id === id);
            
            if (request) {
                request.status = 'Matched';
                request.matcherId = window.appState.userId;
                request.contact = `Matched by User ID: ${window.appState.userId}`;
                saveStateToLocal();
                showMessage(`You joined the ${category} session! Contact details will be visible.`);
            }
        }


        // --- INITIALIZATION ---
        window.initApp = function() {
            window.appState.userId = getLocalUserId();
            loadStateFromLocal(); // Load saved history
            window.appState.isAuthReady = true;
            renderApp();
        };

        // Start the application immediately when the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
             window.initApp();
        });

    </script>
</head>
<body>
    <div id="app-root"></div>
</body>
</html>
