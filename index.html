<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SyncUp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CRITICAL WIX FIX: Ensure the body and HTML take up the full space of the iFrame */
        html, body {
            margin: 0;
            padding: 0;
            background-color: #ffffff; 
            min-height: 1200px;
            width: 100%;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #1f2937; }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 3px solid rgba(255, 255, 255, .3);
            border-radius: 50%;
            border-top-color: #ffffff;
            animation: spin 1s ease-in-out infinite;
        }
        .user-message { 
            background-color: #4b5563; /* Gray-600 */ 
            color: white; 
            align-self: flex-end;
            border-radius: 12px 12px 0 12px;
        }
        .ai-message { 
            background-color: #e5e7eb; /* Gray-200 */ 
            color: #1f2937; 
            align-self: flex-start;
            border-radius: 12px 12px 12px 0;
        }
        /* New CSS for Floating Chatbot */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000; /* Ensure it stays above other content */
        }
        .chat-window {
            width: 340px;
            height: 450px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            background-color: white;
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, updateDoc, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables are provided by the Canvas environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Gemini API Configuration
        const GEMINI_MODEL = "gemini-2.5-flash-preview-05-20";
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=`;
        const GEMINI_SYSTEM_PROMPT = "You are SyncUp, a highly intelligent and helpful campus assistant. Your primary goal is to interpret the user's natural language request and execute it by generating information or converting it into a specific, formal command or query (e.g., searching for current news, writing a summary, or giving an outline). Always respond concisely and politely.";
        
        setLogLevel('Debug');
        
        // Global App State (for Reactivity)
        window.appState = {
            isAuthReady: false,
            userId: null,
            db: null,
            auth: null,
            activePage: 'Home', 
            lostItems: [], 
            foundItems: [], 
            syncRequests: [], 
            message: null,
            socialSyncTab: 'Gym',
            isChatOpen: false, // New state for chat visibility
            chatHistory: [{ role: 'ai', text: "Hello! I'm SyncUp AI, your campus assistant. How can I help you today? Try asking me to look up campus news or summarize a topic." }],
            isChatLoading: false,
        };

        const FIREBASE_COLLECTIONS = {
            LOST: 'lost_items',
            FOUND: 'found_items',
            SYNC: 'sync_requests',
        };

        const SPORTS_OPTIONS = [
            'Swimming', 'Basketball', 'Football', 'Handball', 'Badminton',
            'Squash', 'Table Tennis', 'Tennis', 'Snooker', 'Carrom', 'Chess'
        ];

        // --- FIREBASE UTILITIES ---

        function getCollectionPath(collectionName) {
            // Path structure: artifacts / {appId} / public / data / {collectionName}
            return `artifacts/${appId}/public/data/${collectionName}`;
        }

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                window.appState.db = getFirestore(app);
                window.appState.auth = getAuth(app);
                
                await handleSignIn();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                window.appState.isAuthReady = true;
                renderApp();
            }
        }

        async function handleSignIn() {
            const auth = window.appState.auth;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    window.appState.userId = user.uid;
                    window.appState.isAuthReady = true;
                    attachFirestoreListeners();
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication failed:", error);
                        window.appState.isAuthReady = true;
                        renderApp();
                    }
                }
            });
        }

        function attachFirestoreListeners() {
            const db = window.appState.db;
            if (!db) return;

            // Listener for Lost Items
            onSnapshot(query(collection(db, getCollectionPath(FIREBASE_COLLECTIONS.LOST))), (snapshot) => {
                window.appState.lostItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp();
            }, (error) => { console.error("Error fetching lost items:", error); });

            // Listener for Found Items
            onSnapshot(query(collection(db, getCollectionPath(FIREBASE_COLLECTIONS.FOUND))), (snapshot) => {
                window.appState.foundItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp();
            }, (error) => { console.error("Error fetching found items:", error); });
            
            // Listener for Sync Requests
            onSnapshot(query(collection(db, getCollectionPath(FIREBASE_COLLECTIONS.SYNC))), (snapshot) => {
                window.appState.syncRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp();
            }, (error) => { console.error("Error fetching sync requests:", error); });
        }


        // --- UTILITY FUNCTIONS ---

        function showMessage(text, isError = false) {
            window.appState.message = { text, isError };
            renderApp();
            setTimeout(() => {
                window.appState.message = null;
                renderApp();
            }, 3000);
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            return `${dateStr} at ${timeStr}`;
        }
        
        // --- GEMINI API CHAT LOGIC ---

        async function callGeminiApi(prompt) {
            window.appState.isChatLoading = true;
            renderApp();
            
            let attempts = 0;
            const maxAttempts = 5;
            let delay = 1000;

            while (attempts < maxAttempts) {
                try {
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        tools: [{ "google_search": {} }], 
                        systemInstruction: {
                            parts: [{ text: GEMINI_SYSTEM_PROMPT }]
                        },
                    };

                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API returned status ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't process that request.";
                    
                    window.appState.isChatLoading = false;
                    
                    window.appState.chatHistory.push({ role: 'ai', text: text });
                    renderApp();
                    
                    const chatWindow = document.getElementById('chat-messages');
                    if (chatWindow) {
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    }
                    return; 
                } catch (error) {
                    attempts++;
                    console.error(`Attempt ${attempts} failed:`, error);
                    if (attempts < maxAttempts) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    } else {
                        window.appState.isChatLoading = false;
                        window.appState.chatHistory.push({ role: 'ai', text: "I'm having trouble connecting right now. Please try again later." });
                        renderApp();
                    }
                }
            }
        }
        
        // --- UI COMPONENTS (Formal Design) ---

        function renderLoading() {
            return `
                <div class="flex flex-col items-center justify-center min-h-screen w-full bg-gray-50 p-10">
                    <div class="spinner border-gray-300 border-t-gray-700"></div>
                    <p class="mt-4 text-gray-700 font-medium">Authenticating User and Loading SyncUp Data...</p>
                    <p class="text-sm text-gray-500 mt-2">Persistence enabled. Your history will be saved.</p>
                </div>
            `;
        }

        function getHeaderHtml() {
            const pages = ['Home', 'Lost & Found', 'Social Sync']; // Removed 'AI Chat'
            return `
                <div class="w-full bg-gray-800 text-white shadow-md sticky top-0 z-10 border-b border-gray-700">
                    <div class="max-w-6xl mx-auto p-4 flex justify-between items-center">
                        <h1 class="text-3xl font-serif font-bold tracking-widest text-white">SYNCUP</h1>
                        <div id="user-id-display" class="text-xs bg-gray-700 px-3 py-1 rounded-sm opacity-75">
                            User ID: ${window.appState.userId ? window.appState.userId.substring(0, 15) + '...' : 'Connecting...'}
                        </div>
                    </div>
                    <nav class="max-w-6xl mx-auto flex justify-center">
                        ${pages.map(page => `
                            <button data-page="${page}" 
                                class="page-button px-6 py-3 text-center text-lg font-medium transition-all duration-300 
                                ${window.appState.activePage === page ? 'border-b-4 border-slate-300 text-slate-300 bg-gray-700' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}"
                            >
                                ${page}
                            </button>
                        `).join('')}
                    </nav>
                </div>
            `;
        }
        
        // --- HOME PAGE RENDERING ---

        function renderHomePage() {
            // ... (Home page content remains the same)
            return `
                <div class="w-full max-w-6xl p-6 space-y-12">
                    <!-- Hero Image -->
                    <div class="rounded-lg overflow-hidden border border-gray-300">
                        <img src="https://placehold.co/1200x200/1F2937/ffffff?text=SyncUp+Student+Services" 
                             onerror="this.onerror=null; this.src='https://placehold.co/1200x200/1F2937/ffffff?text=SyncUp+Student+Services';" 
                             alt="SyncUp Banner" class="w-full h-auto object-cover">
                    </div>

                    <h2 class="text-3xl font-bold text-gray-800 text-center border-b pb-2">Centralized Campus Connection</h2>
                    
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Lost & Found Intro Card -->
                        <div class="bg-white p-8 rounded-lg shadow-sm border border-gray-200 border-t-4 border-red-800 hover:shadow-md transition duration-300">
                            <h3 class="text-xl font-semibold text-red-800 mb-3 border-b pb-1">Lost & Found Service</h3>
                            <p class="text-gray-600 mb-6">A straightforward channel for reporting lost possessions and listing found items. Our system facilitates quick, verified contact exchange for efficient item recovery.</p>
                            <img src="https://placehold.co/600x250/B91C1C/ffffff?text=Lost+Assets" alt="Lost and Found" class="w-full h-32 object-cover rounded-md mb-4 border border-gray-200">
                            <button data-page="Lost & Found" class="page-button w-full py-2 px-4 rounded-sm shadow-sm text-white font-medium bg-gray-700 hover:bg-gray-800 transition duration-150">
                                Access Lost & Found
                            </button>
                        </div>
                        
                        <!-- Social Sync Intro Card -->
                        <div class="bg-white p-8 rounded-lg shadow-sm border border-gray-200 border-t-4 border-slate-700 hover:shadow-md transition duration-300">
                            <h3 class="text-xl font-semibold text-slate-700 mb-3 border-b pb-1">Social Sync Coordination</h3>
                            <p class="text-gray-600 mb-6">Coordinate specific meetups for athletic, fitness, or academic purposes. Post your time and location to instantly find a reliable partner or group.</p>
                            <img src="https://placehold.co/600x250/475569/ffffff?text=Social+Coordination" alt="Social Sync" class="w-full h-32 object-cover rounded-md mb-4 border border-gray-200">
                            <button data-page="Social Sync" class="page-button w-full py-2 px-4 rounded-sm shadow-sm text-white font-medium bg-slate-700 hover:bg-slate-800 transition duration-150">
                                Access Social Sync
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }


        function getFooterHtml() {
            return `
                <div class="w-full bg-gray-100 mt-8 py-4 text-center text-gray-600 text-sm border-t border-gray-300">
                    &copy; ${new Date().getFullYear()} SyncUp. Data is saved in the cloud.
                </div>
            `;
        }

        function renderMessage() {
            if (!window.appState.message) return '';
            const { text, isError } = window.appState.message;
            const bgColor = isError ? 'bg-red-700' : 'bg-teal-700'; 
            return `
                <div class="fixed top-0 left-1/2 transform -translate-x-1/2 mt-4 p-4 rounded-md shadow-xl text-white font-semibold z-50 transition-opacity duration-500 ${bgColor}">
                    ${text}
                </div>
            `;
        }

        // --- LOST & FOUND RENDERING (Adapted for Firebase IDs) ---

        function renderLostAndFound() {
             // ... (Rest of L&F rendering remains the same)
            return `
                <div class="w-full max-w-6xl p-6 space-y-8">
                    <img src="https://placehold.co/1200x150/1F2937/ffffff?text=LOST+%26+FOUND+DIRECTORY" alt="Lost and Found Header" class="w-full rounded-md shadow-sm mb-4 border border-gray-300">
                    <h2 class="text-3xl font-bold text-gray-800 border-b pb-2 border-red-800">Lost & Found Center</h2>

                    <!-- Posting Forms -->
                    <div class="grid md:grid-cols-2 gap-6">
                        ${renderLostItemForm()}
                        ${renderFoundItemForm()}
                    </div>

                    <!-- Listings -->
                    ${renderLostAndFoundListings()}
                </div>
            `;
        }

        function renderLostItemForm() {
            // ... (Lost Item form remains the same)
            return `
                <div class="bg-white p-6 rounded-md shadow-sm border border-gray-200 border-t-4 border-red-800">
                    <h3 class="text-xl font-semibold mb-4 text-red-800">Report Lost Item</h3>
                    <form id="lost-item-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Item Name</label>
                            <input type="text" id="lost-item-name" required class="mt-1 block w-full rounded-sm border-gray-300 shadow-sm p-2 border focus:border-red-800 focus:ring-red-800">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Description / Last Seen</label>
                            <textarea id="lost-item-desc" required rows="3" class="mt-1 block w-full rounded-sm border-gray-300 shadow-sm p-2 border focus:border-red-800 focus:ring-red-800"></textarea>
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-sm shadow-sm text-white font-medium bg-red-800 hover:bg-red-900 transition duration-150">
                            Post Lost Item
                        </button>
                    </form>
                </div>
            `;
        }

        function renderFoundItemForm() {
            // ... (Found Item form remains the same)
            return `
                <div class="bg-white p-6 rounded-md shadow-sm border border-gray-200 border-t-4 border-green-800">
                    <h3 class="text-xl font-semibold mb-4 text-green-800">List Found Item</h3>
                    <form id="found-item-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Item Name</label>
                            <input type="text" id="found-item-name" required class="mt-1 block w-full rounded-sm border-gray-300 shadow-sm p-2 border focus:border-green-800 focus:ring-green-800">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Location Found</label>
                            <textarea id="found-item-desc" required rows="3" class="mt-1 block w-full rounded-sm border-gray-300 shadow-sm p-2 border focus:border-green-800 focus:ring-green-800"></textarea>
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-sm shadow-sm text-white font-medium bg-green-800 hover:bg-green-900 transition duration-150">
                            Post Found Item
                        </button>
                    </form>
                </div>
            `;
        }

        function renderLostAndFoundListings() {
            // Sort by latest post first (using timestamp for real-time data)
            const allItems = [...window.appState.lostItems, ...window.appState.foundItems].sort((a, b) => {
                const tsA = (a.timestamp && a.timestamp.seconds) ? a.timestamp.seconds : 0;
                const tsB = (b.timestamp && b.timestamp.seconds) ? b.timestamp.seconds : 0;
                return tsB - tsA;
            });

            return `
                <div class="space-y-6">
                    <h3 class="text-2xl font-bold text-gray-800 pt-4 border-b border-gray-200 pb-2">Community Listings (${allItems.length} Active)</h3>
                    <div class="space-y-4">
                        ${allItems.length === 0 ? '<p class="text-gray-500 text-center py-8 bg-gray-50 rounded-md shadow-inner border border-gray-200">No active listings right now. Be the first to post!</p>' : allItems.map(item => {
                            const isLost = item.type === 'Lost';
                            const borderColor = isLost ? 'border-red-800' : 'border-green-800';
                            const titleColor = isLost ? 'text-red-800' : 'text-green-800';
                            const buttonColor = isLost ? 'bg-gray-700 hover:bg-gray-900' : 'bg-slate-700 hover:bg-slate-800';
                            const buttonText = isLost ? 'I Found This Item!' : 'I Lost This Item!';
                            const timestamp = formatTimestamp(item.timestamp);
                            const isPoster = item.posterId === window.appState.userId;

                            return `
                                <div class="bg-white p-4 rounded-md shadow-sm border border-gray-200 border-l-4 ${borderColor} flex justify-between items-center transition duration-200 hover:shadow-md">
                                    <div>
                                        <div class="font-semibold text-base ${titleColor}">${item.type} | ${item.item}</div>
                                        <p class="text-gray-600 text-sm">${item.description}</p>
                                        <p class="text-xs text-gray-500 mt-1">Posted: ${timestamp} ${isPoster ? '(Your Post)' : ''}</p>
                                        <span class="text-xs font-medium ${item.status === 'Matched' ? 'text-teal-700' : 'text-gray-500'}">
                                            Status: ${item.status}
                                        </span>
                                        ${item.status === 'Matched' ? `<p class="mt-1 text-sm font-bold text-gray-800">Contact: ${item.contact}</p>` : ''}
                                    </div>
                                    ${item.status === 'Active' && !isPoster ? `
                                        <button data-id="${item.id}" data-type="${item.type}" class="match-item-btn py-2 px-4 rounded-sm text-white font-medium text-sm ${buttonColor} transition duration-150">
                                            ${buttonText}
                                        </button>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // --- SOCIAL SYNC RENDERING (Adapted for Firebase IDs) ---

        function renderSocialSync() {
            const categories = ['Gym', 'Sports', 'Study'];

            return `
                <div class="w-full max-w-6xl p-6 space-y-8">
                    <img src="https://placehold.co/1200x150/475569/ffffff?text=SOCIAL+SYNC+COORDINATION" alt="Social Sync Header" class="w-full rounded-md shadow-sm mb-4 border border-gray-300">
                    <h2 class="text-3xl font-bold text-gray-800 border-b pb-2 border-slate-700">Social Sync Matchmaker</h2>
                    
                    <!-- Internal Tabs for Social Sync -->
                    <div class="flex border-b border-gray-200">
                        ${categories.map(cat => `
                            <button data-sync-tab="${cat}" 
                                class="sync-tab-button px-4 py-2 text-center text-lg font-medium transition-all duration-300 
                                ${window.appState.socialSyncTab === cat ? 'border-b-4 border-slate-700 text-slate-700 font-semibold' : 'text-gray-500 hover:text-slate-700'}"
                            >
                                ${cat}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div id="social-sync-content">
                        ${renderSyncPostForm(categories)}
                        ${renderSyncListings(window.appState.socialSyncTab)}
                    </div>
                </div>
            `;
        }

        function renderSyncPostForm(categories) {
            // ... (Sync post form remains the same)
            return `
                <div class="bg-white p-6 rounded-md shadow-sm border border-gray-200 border-t-4 border-slate-700 mt-6">
                    <h3 class="text-xl font-semibold mb-4 text-slate-700">Post a Sync-Up Request</h3>
                    <form id="sync-post-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Category</label>
                            <select id="sync-category" required class="mt-1 block w-full rounded-sm border-gray-300 shadow-sm p-2 border focus:border-slate-700 focus:ring-slate-700">
                                <option value="">Select Category</option>
                                ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                        </div>
                        <div id="sport-select-container" class="hidden">
                            <label class="block text-sm font-medium text-gray-700">Select Sport</label>
                            <select id="sync-sport" class="mt-1 block w-full rounded-sm border-gray-300 shadow-sm p-2 border focus:border-slate-700 focus:ring-slate-700">
                                ${SPORTS_OPTIONS.map(sport => `<option value="${sport}">${sport}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Time / Location</label>
                            <input type="text" id="sync-time" placeholder="e.g., 6 PM at Rec Center" required class="mt-1 block w-full rounded-sm border-gray-300 shadow-sm p-2 border focus:border-slate-700 focus:ring-slate-700">
                        </div>
                        <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-sm shadow-sm text-white font-medium bg-slate-700 hover:bg-slate-800 transition duration-150">
                            Post Sync Request
                        </button>
                    </form>
                </div>
            `;
        }

        function renderSyncListings(activeCategory) {
            const categoryRequests = window.appState.syncRequests.filter(req => req.category === activeCategory && req.status === 'Active');
            
            return `
                <div class="mt-6 space-y-4">
                    <h3 class="text-2xl font-bold text-gray-800">Active ${activeCategory} Requests</h3>
                    <div class="bg-gray-50 p-4 rounded-md shadow-inner border border-gray-200">
                        <div class="space-y-3 max-h-96 overflow-y-auto p-2">
                            ${categoryRequests.length === 0 ? `<p class="text-gray-500 text-sm py-4 text-center">No active requests for ${activeCategory} right now. Post one above!</p>` : categoryRequests.map(req => {
                                const timestamp = formatTimestamp(req.timestamp); 
                                const categoryAccent = req.category === 'Gym' ? 'border-blue-700' : req.category === 'Sports' ? 'border-orange-700' : 'border-purple-700';
                                const isPoster = req.posterId === window.appState.userId;

                                return `
                                <div class="bg-white p-3 rounded-md shadow-sm border border-gray-300 border-l-4 ${categoryAccent}">
                                    <div class="font-semibold text-gray-800">${req.time}</div>
                                    <p class="text-xs text-gray-600 mt-1">${req.details}</p>
                                    ${req.sport ? `<span class="text-xs font-medium text-slate-700">Activity: ${req.sport}</span>` : ''}
                                    <p class="text-xs text-gray-500 mt-1">Posted: ${timestamp} ${isPoster ? '(Your Post)' : ''}</p>
                                    ${req.status === 'Active' && !isPoster ? `
                                        <button data-id="${req.id}" data-category="${req.category}" class="join-sync-btn mt-2 w-full py-1 px-3 text-sm rounded-sm text-white font-medium bg-gray-700 hover:bg-gray-800 transition duration-150">
                                            Join Session
                                        </button>
                                    ` : `
                                        <div class="mt-2 text-xs text-center p-1 font-medium text-gray-500 bg-gray-100 rounded-sm">
                                            ${isPoster ? 'Awaiting Join' : 'Not Active'}
                                        </div>
                                    `}
                                </div>
                            `;
                            }).join('')}
                             ${window.appState.syncRequests.filter(req => req.category === activeCategory && req.status === 'Matched').map(req => {
                                const isMatchRelevant = req.posterId === window.appState.userId || req.matcherId === window.appState.userId;
                                if (!isMatchRelevant) return '';

                                return `
                                <div class="bg-gray-100 p-3 rounded-md shadow-sm border border-green-700 border-l-2 opacity-80">
                                    <div class="font-semibold text-green-700">${req.time} - MATCHED!</div>
                                    <p class="text-xs text-gray-600 mt-1">Contact: ${req.contact}</p>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- CHATBOT RENDERING (AS A FLOATING WIDGET) ---
        
        function renderFloatingChat() {
            // Scroll to bottom after the element is rendered and listeners are attached
            if (window.appState.isChatOpen) {
                requestAnimationFrame(() => {
                    const chatWindow = document.getElementById('chat-messages');
                    if (chatWindow) {
                        chatWindow.scrollTop = chatWindow.scrollHeight;
                    }
                });
            }

            // Main chat window content
            const chatWindowContent = `
                <div class="chat-window rounded-lg border border-gray-300 overflow-hidden ${window.appState.isChatOpen ? '' : 'hidden'}">
                    <header class="bg-gray-800 text-white p-3 flex justify-between items-center shadow-md">
                        <span class="font-semibold">SyncUp AI Assistant</span>
                        <button id="close-chat-btn" aria-label="Close Chat Window" class="text-white hover:text-gray-300">
                            &times;
                        </button>
                    </header>
                    
                    <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4 bg-white">
                        ${window.appState.chatHistory.map(msg => `
                            <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                                <div class="max-w-[75%] p-3 shadow-md text-sm ${msg.role === 'user' ? 'user-message' : 'ai-message'}">
                                    ${msg.text.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        `).join('')}

                        ${window.appState.isChatLoading ? `
                            <div class="flex justify-start">
                                <div class="max-w-[75%] p-3 shadow-md text-sm ai-message flex items-center space-x-2">
                                    <div class="spinner w-4 h-4 border-gray-400 border-t-gray-700"></div>
                                    <span>SyncUp AI is thinking...</span>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <form id="chat-form" class="flex p-3 border-t border-gray-200">
                        <input type="text" id="chat-input" placeholder="Ask SyncUp AI..." required 
                               class="flex-grow rounded-l-sm border-gray-300 shadow-sm p-2 border text-gray-700 focus:outline-none">
                        <button type="submit" ${window.appState.isChatLoading ? 'disabled' : ''}
                                class="py-2 px-4 rounded-r-sm text-white font-medium bg-gray-800 hover:bg-black transition duration-150 disabled:bg-gray-500"
                                aria-label="Send Message">
                            Send
                        </button>
                    </form>
                </div>
            `;

            // Main toggle button
            const toggleButton = `
                <button id="toggle-chat-btn" aria-label="${window.appState.isChatOpen ? 'Close Chat' : 'Open Chat'}"
                        class="w-14 h-14 rounded-full bg-gray-800 text-white shadow-xl hover:bg-black transition duration-150 flex items-center justify-center text-2xl font-bold"
                        style="display: ${window.appState.isChatOpen ? 'none' : 'flex'}">
                    AI
                </button>
            `;

            return `
                <div class="chat-widget">
                    ${chatWindowContent}
                    ${toggleButton}
                </div>
            `;
        }


        // --- MAIN RENDER LOOP ---

        function renderApp() {
            const appRoot = document.getElementById('app-root');
            let mainContent = '';

            if (!window.appState.isAuthReady) {
                appRoot.innerHTML = renderLoading();
                return; 
            }
            
            switch (window.appState.activePage) {
                case 'Home':
                    mainContent = renderHomePage();
                    break;
                case 'Lost & Found':
                    mainContent = renderLostAndFound();
                    break;
                case 'Social Sync':
                    mainContent = renderSocialSync();
                    break;
                default:
                    mainContent = renderHomePage();
            }

            // 1. Render the main structure
            appRoot.innerHTML = `
                ${renderMessage()}
                ${getHeaderHtml()}
                <main class="w-full mx-auto py-8 bg-gray-100">
                    <div id="app-container" class="flex justify-center">
                        ${mainContent}
                    </div>
                </main>
                ${getFooterHtml()}
                ${renderFloatingChat()} 
            `;

            // 2. Attach all listeners after rendering
            attachHeaderListeners();
            if (window.appState.activePage === 'Lost & Found') {
                attachLostAndFoundListeners();
            } else if (window.appState.activePage === 'Social Sync') {
                attachSocialSyncListeners();
            }
            attachChatbotListeners();
        }

        // --- LISTENER ATTACHMENT ---
        
        function toggleChat() {
             window.appState.isChatOpen = !window.appState.isChatOpen;
             renderApp();
        }

        function attachChatbotListeners() {
            // Toggle Button listeners
            const toggleBtn = document.getElementById('toggle-chat-btn');
            if (toggleBtn) {
                toggleBtn.onclick = toggleChat;
            }

            const closeBtn = document.getElementById('close-chat-btn');
            if (closeBtn) {
                closeBtn.onclick = toggleChat;
            }

            // Chat Form submission listener (only attach if chat is open)
            if (window.appState.isChatOpen) {
                const chatForm = document.getElementById('chat-form');
                if (chatForm) {
                    chatForm.onsubmit = (e) => {
                        e.preventDefault();
                        const input = document.getElementById('chat-input');
                        const prompt = input.value.trim();
                        
                        if (prompt && !window.appState.isChatLoading) {
                            window.appState.chatHistory.push({ role: 'user', text: prompt });
                            input.value = ''; 
                            callGeminiApi(prompt);
                        }
                    };
                }
            }
        }
        
        function attachHeaderListeners() {
            document.querySelectorAll('.page-button').forEach(button => {
                button.onclick = (e) => {
                    const newPage = e.currentTarget.dataset.page;
                    if (window.appState.activePage !== newPage) {
                        window.appState.activePage = newPage;
                        renderApp();
                    }
                };
            });
        }
        
        function attachSocialSyncListeners() {
             // Attach listeners for the internal Social Sync tabs
            document.querySelectorAll('.sync-tab-button').forEach(button => {
                button.onclick = (e) => {
                    const newSyncTab = e.currentTarget.dataset.syncTab;
                    if (window.appState.socialSyncTab !== newSyncTab) {
                        window.appState.socialSyncTab = newSyncTab;
                        renderApp();
                    }
                };
            });

            const syncForm = document.getElementById('sync-post-form');
            const categorySelect = document.getElementById('sync-category');
            const sportSelectContainer = document.getElementById('sport-select-container');

            if (categorySelect) {
                categorySelect.onchange = () => {
                    if (categorySelect.value === 'Sports') {
                        sportSelectContainer.classList.remove('hidden');
                    } else {
                        sportSelectContainer.classList.add('hidden');
                    }
                };
            }

            if (syncForm) {
                syncForm.onsubmit = (e) => {
                    e.preventDefault();
                    const category = categorySelect.value;
                    const sport = category === 'Sports' ? document.getElementById('sync-sport').value : null;
                    const time = document.getElementById('sync-time').value;
                    handlePostSyncRequest(category, sport, time);
                };
            }

            document.querySelectorAll('.join-sync-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.currentTarget.dataset.id;
                    const category = e.currentTarget.dataset.category;
                    handleJoinSyncRequest(id, category);
                };
            });
        }
        
        function attachLostAndFoundListeners() {
            const lostForm = document.getElementById('lost-item-form');
            if (lostForm) {
                lostForm.onsubmit = (e) => {
                    e.preventDefault();
                    const name = document.getElementById('lost-item-name').value;
                    const desc = document.getElementById('lost-item-desc').value;
                    handlePostLostItem(name, desc);
                };
            }

            const foundForm = document.getElementById('found-item-form');
            if (foundForm) {
                foundForm.onsubmit = (e) => {
                    e.preventDefault();
                    const name = document.getElementById('found-item-name').value;
                    const desc = document.getElementById('found-item-desc').value;
                    handlePostFoundItem(name, desc);
                };
            }

            document.querySelectorAll('.match-item-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.currentTarget.dataset.id;
                    const type = e.currentTarget.dataset.type;
                    handleMatchItem(id, type);
                };
            });
        }
        
        // --- HANDLERS (FIREBASE LOGIC) ---
        
        async function handlePostLostItem(name, desc) {
            const db = window.appState.db;
            if (!db) return showMessage('Error: Database not connected.', true);

            try {
                await addDoc(collection(db, getCollectionPath(FIREBASE_COLLECTIONS.LOST)), {
                    type: 'Lost',
                    item: name,
                    description: desc,
                    posterId: window.appState.userId,
                    contact: `User ID: ${window.appState.userId}`, // Contact initially set to poster's ID
                    status: 'Active',
                    timestamp: new Date(),
                });
                showMessage(`Lost item "${name}" posted successfully and saved!`);
                document.getElementById('lost-item-form').reset();
            } catch (e) {
                showMessage('Error posting item. Check permissions.', true);
                console.error("Error adding document: ", e);
            }
        }

        async function handlePostFoundItem(name, desc) {
            const db = window.appState.db;
            if (!db) return showMessage('Error: Database not connected.', true);

            try {
                await addDoc(collection(db, getCollectionPath(FIREBASE_COLLECTIONS.FOUND)), {
                    type: 'Found',
                    item: name,
                    description: desc,
                    posterId: window.appState.userId,
                    contact: `User ID: ${window.appState.userId}`, 
                    status: 'Active',
                    timestamp: new Date(),
                });
                showMessage(`Found item "${name}" listed successfully and saved!`);
                document.getElementById('found-item-form').reset();
            } catch (e) {
                showMessage('Error listing item. Check permissions.', true);
                console.error("Error adding document: ", e);
            }
        }

        async function handleMatchItem(id, type) {
            const db = window.appState.db;
            if (!db) return showMessage('Error: Database not connected.', true);
            
            const collectionName = type === 'Lost' ? FIREBASE_COLLECTIONS.LOST : FIREBASE_COLLECTIONS.FOUND;

            try {
                await updateDoc(doc(db, getCollectionPath(collectionName), id), {
                    status: 'Matched',
                    matcherId: window.appState.userId,
                    contact: `Matched by User ID: ${window.appState.userId}`,
                });
                showMessage(`Match confirmed! Contact details will be visible to both parties.`);
            } catch (e) {
                showMessage('Error confirming match. Check permissions.', true);
                console.error("Error updating document: ", e);
            }
        }

        async function handlePostSyncRequest(category, sport, time) {
            const db = window.appState.db;
            if (!db) return showMessage('Error: Database not connected.', true);

            const details = `Looking to sync up for ${category} session. Meeting at: ${time}`; 

            try {
                await addDoc(collection(db, getCollectionPath(FIREBASE_COLLECTIONS.SYNC)), {
                    category: category,
                    sport: sport,
                    time: time,
                    details: details,
                    posterId: window.appState.userId,
                    contact: `User ID: ${window.appState.userId}`,
                    status: 'Active',
                    timestamp: new Date(),
                });
                showMessage(`${category} request posted successfully and saved!`);
                document.getElementById('sync-post-form').reset();
            } catch (e) {
                showMessage('Error posting request. Check permissions.', true);
                console.error("Error adding document: ", e);
            }
        }

        async function handleJoinSyncRequest(id, category) {
            const db = window.appState.db;
            if (!db) return showMessage('Error: Database not connected.', true);
            
            try {
                await updateDoc(doc(db, getCollectionPath(FIREBASE_COLLECTIONS.SYNC), id), {
                    status: 'Matched',
                    matcherId: window.appState.userId,
                    contact: `Matched by User ID: ${window.appState.userId}`,
                });
                showMessage(`You joined the ${category} session! Contact details will be visible.`);
            } catch (e) {
                showMessage('Error confirming join. Check permissions.', true);
                console.error("Error updating document: ", e);
            }
        }


        // --- INITIALIZATION ---
        window.initApp = function() {
            initializeFirebase();
        };

        // Start the application immediately when the DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
             window.initApp();
        });

    </script>
</body>
</html>
